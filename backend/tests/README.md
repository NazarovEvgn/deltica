# Тестирование функционала загрузки файлов

## Обзор

Создана комплексная система тестирования для функционала загрузки, просмотра, скачивания и удаления файлов оборудования.

## Статистика тестов

**Всего тестов: 98**
- ✅ Unit-тесты: 39
- ✅ Интеграционные тесты: 17
- ✅ Тесты безопасности: 20
- ✅ Тесты кодировки: 16
- ✅ Тесты параллельности: 6

**Результат: 98/98 passed (100%)**

## Структура тестов

### 1. Unit-тесты (`test_file_utils.py`)

Тестируют изолированные функции без БД и файловой системы:

- **Получение расширений файлов** (6 тестов)
  - Обработка различных форматов (pdf, docx, xlsx, jpg, png)
  - Case-insensitive обработка
  - Файлы без расширений

- **Валидация допустимых расширений** (13 тестов)
  - Разрешенные форматы: `.pdf`, `.doc`, `.docx`, `.xls`, `.xlsx`, `.jpg`, `.jpeg`, `.png`
  - Запрещенные форматы: `.exe`, `.sh`, `.py`, `.bat`, `.com`, `.scr`

- **Санитизация имен файлов** (9 тестов)
  - Удаление опасных символов
  - Замена пробелов на подчеркивания
  - Защита от path traversal (`../../etc/passwd`)
  - Обработка кириллицы

- **Определение MIME-типов** (11 тестов)
  - Правильное определение типов для всех поддерживаемых форматов
  - Fallback на `application/octet-stream` для неизвестных типов

### 2. Интеграционные тесты API (`test_files_api.py`)

Тестируют полный цикл работы с файлами через API:

- **Загрузка файлов** (6 тестов)
  - Успешная загрузка PDF и изображений
  - Валидация оборудования (404 для несуществующего)
  - Отклонение недопустимых расширений
  - Отклонение файлов > 50 МБ
  - Обработка дубликатов имен файлов (автоматические суффиксы)

- **Получение списка файлов** (3 теста)
  - Пустой список для оборудования без файлов
  - Корректный список с метаданными
  - 404 для несуществующего оборудования

- **Просмотр файлов** (2 теста)
  - Успешный просмотр с `inline` Content-Disposition
  - 404 для несуществующих файлов

- **Скачивание файлов** (2 теста)
  - Успешное скачивание с `attachment` Content-Disposition
  - 404 для несуществующих файлов

- **Удаление файлов** (3 теста)
  - Успешное удаление файла и с диска
  - 404 для несуществующих файлов
  - Автоматическое удаление пустых директорий

- **Каскадное удаление** (1 тест)
  - Проверка удаления файлов при удалении оборудования

### 3. Тесты безопасности (`test_files_security.py`)

Проверяют защиту от атак и граничные условия:

- **Защита от Path Traversal** (4 теста)
  - Unix-style: `../../etc/passwd`
  - Windows-style: `..\\..\\windows\\system32`
  - Абсолютные пути: `/var/www/html/shell.pdf`
  - Null byte injection: `file.pdf\x00.exe`

- **Ограничения размера файлов** (3 теста)
  - Файл ровно 50 МБ (разрешен)
  - Файл 50 МБ + 1 байт (отклонен)
  - Пустой файл 0 байт (разрешен)

- **Валидация расширений** (8 тестов)
  - Параметризованные тесты для всех форматов
  - Защита от двойных расширений: `file.pdf.exe`
  - Case-insensitive проверка

- **Защита от инъекций через имя файла** (3 теста)
  - Санитизация спецсимволов: `@#$%^&*()`
  - Удаление Unicode control characters (RTL override)
  - Обработка очень длинных имен

- **Параллельные загрузки** (2 теста)
  - Загрузка разных файлов одновременно
  - Race condition при загрузке одинаковых имен

### 4. Тесты кодировки (`test_files_encoding.py`)

Проверяют корректную обработку кириллических имен файлов:

- **Кириллические имена** (4 теста)
  - Загрузка: `Сертификат поверки №123.pdf`
  - Просмотр с правильным UTF-8 encoding
  - Скачивание с RFC 5987 форматом
  - Сохранение в БД без искажений

- **Смешанные языки** (4 теста)
  - `Certificate Сертификат №123.pdf`
  - `Паспорт Device Model-2023.pdf`
  - `Документация_Equipment_v1.0.pdf`

- **Специальные символы** (3 теста)
  - Кириллица с числами: `Сертификат №12345 от 2024.pdf`
  - Кириллица с пробелами
  - Кириллица со скобками

- **Списки файлов** (1 тест)
  - Корректное отображение множественных кириллических файлов

- **Граничные случаи** (3 теста)
  - Длинные кириллические имена (100+ символов)
  - Только кириллица: `Сертификат.pdf`
  - Только латиница: `Certificate.pdf`

- **Content-Disposition заголовки** (1 тест)
  - Соответствие RFC 5987: `filename*=UTF-8''%encoded%name`

## Конфигурация тестов

### Fixtures (`conftest.py`)

- **db_session**: In-memory SQLite для изоляции тестов
- **client**: FastAPI TestClient с подменой БД
- **temp_upload_dir**: Временная директория для файлов
- **test_equipment**: Тестовое оборудование в БД
- **sample_pdf_file**: Минимальный валидный PDF
- **sample_image_file**: Минимальный валидный PNG (1x1 пиксель)
- **sample_cyrillic_file**: PDF с кириллическим именем
- **large_file**: Файл 51 МБ для теста лимита
- **invalid_extension_file**: Shell-скрипт для теста валидации

### Особенности

- **Изоляция**: Каждый тест использует свежую БД и временную директорию
- **SQLite совместимость**: Ручное создание таблиц без PostgreSQL-specific computed columns
- **Автоочистка**: Временные файлы и таблицы удаляются после каждого теста

## Запуск тестов

```bash
# Все тесты файлов
uv run pytest backend/tests/test_file*.py -v

# Только unit-тесты
uv run pytest backend/tests/test_file_utils.py -v

# Только интеграционные
uv run pytest backend/tests/test_files_api.py -v

# Только безопасность
uv run pytest backend/tests/test_files_security.py -v

# Только кодировка
uv run pytest backend/tests/test_files_encoding.py -v

# С покрытием кода
uv run pytest backend/tests/test_file*.py --cov=backend.routes.files --cov-report=html
```

## Покрываемый функционал

✅ Загрузка файлов (upload)
✅ Просмотр файлов в браузере (view)
✅ Скачивание файлов (download)
✅ Удаление файлов (delete)
✅ Список файлов оборудования (list)
✅ Валидация типов файлов
✅ Ограничение размера (50 МБ)
✅ Санитизация имен файлов
✅ Защита от path traversal
✅ Обработка дубликатов
✅ UTF-8/кириллица в именах
✅ MIME-типы для всех форматов
✅ Content-Disposition headers (RFC 5987)
✅ Cascade delete при удалении оборудования

## Зоны риска (требуют осторожности)

⚠️ **Windows path limits**: Очень длинные имена могут превысить 260 символов
⚠️ **Concurrent uploads**: Race conditions при одновременной загрузке
⚠️ **Disk space**: Нет проверки свободного места на диске
⚠️ **File cleanup**: Orphaned files при сбоях (нет периодической очистки)

## Рекомендации

1. **Production**: Использовать PostgreSQL для тестирования (вместо SQLite) для проверки computed columns и triggers
2. **CI/CD**: Добавить автоматический запуск тестов при каждом commit
3. **Coverage**: Стремиться к покрытию >90% для критического функционала
4. **Performance**: Добавить тесты производительности для больших файлов
5. **E2E**: Рассмотреть добавление end-to-end тестов через Playwright/Cypress
