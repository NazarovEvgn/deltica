# Управление пользователями Deltica

## Описание

Пользователи системы управляются через конфигурационный файл `users_config.yaml`.
Это позволяет легко добавлять, изменять и деактивировать пользователей без необходимости работы с базой данных напрямую.

## Быстрый старт

### 1. Создание конфигурационного файла

Если файл `users_config.yaml` отсутствует, скопируйте пример:

```bash
cp config/users_config.yaml.example config/users_config.yaml
```

### 2. Редактирование пользователей

Откройте `config/users_config.yaml` и отредактируйте список пользователей:

```yaml
users:
  - username: admin
    password: new_secure_password  # ОБЯЗАТЕЛЬНО измените дефолтный пароль!
    full_name: Администратор Системы
    department: Администрация
    role: admin
    is_active: true

  - username: ivanov
    password: secure_password_123
    full_name: Иванов Иван Иванович
    department: Отдел добычи
    role: laborant
    is_active: true
```

### 3. Синхронизация с базой данных

После изменения конфига запустите синхронизацию:

```bash
uv run python backend/scripts/sync_users.py
```

Скрипт:
- Создаст новых пользователей
- Обновит данные существующих (ФИО, подразделение, роль, пароль, статус)
- Выведет отчёт о выполненных изменениях

## Структура конфигурационного файла

### Формат YAML

```yaml
users:
  - username: логин          # Обязательно, латиница без пробелов
    password: пароль         # Обязательно, в открытом виде (будет захеширован)
    full_name: ФИО          # Обязательно
    department: подразделение  # Обязательно (должно совпадать с таблицей responsibility)
    role: роль              # admin или laborant
    is_active: true/false   # Активен ли пользователь
```

### Поля

| Поле | Тип | Обязательно | Описание |
|------|-----|-------------|----------|
| `username` | string | Да | Логин для входа (латиница, без пробелов) |
| `password` | string | Да | Пароль в открытом виде (будет автоматически захеширован) |
| `full_name` | string | Да | ФИО пользователя |
| `department` | string | Да | Подразделение (должно совпадать с `department` в таблице `responsibility`) |
| `role` | enum | Да | Роль: `admin` или `laborant` |
| `is_active` | boolean | Нет (по умолчанию `true`) | Активен ли пользователь |

### Роли пользователей

#### admin (Администратор)
- Полный доступ ко всем данным
- Может добавлять, редактировать и удалять оборудование
- Видит всё оборудование всех подразделений
- Доступ к архиву

#### laborant (Лаборант)
- Доступ только для чтения
- Видит только оборудование своего подразделения
- Не может добавлять, редактировать или удалять записи
- Нет доступа к архиву

## Типичные операции

### Добавление нового пользователя

1. Откройте `config/users_config.yaml`
2. Добавьте нового пользователя в список:

```yaml
users:
  # ... существующие пользователи ...

  - username: new_user
    password: temp_password_123
    full_name: Новый Пользователь
    department: Отдел добычи
    role: laborant
    is_active: true
```

3. Запустите синхронизацию:

```bash
uv run python backend/scripts/sync_users.py
```

### Изменение пароля пользователя

1. Найдите пользователя в `config/users_config.yaml`
2. Измените значение поля `password`:

```yaml
- username: ivanov
  password: new_secure_password_456  # Новый пароль
  full_name: Иванов Иван Иванович
  department: Отдел добычи
  role: laborant
  is_active: true
```

3. Запустите синхронизацию:

```bash
uv run python backend/scripts/sync_users.py
```

**Важно:** Пароль хранится в конфиге в открытом виде для удобства администрирования. При синхронизации он автоматически хешируется bcrypt перед сохранением в БД.

### Изменение роли пользователя

Измените поле `role` с `laborant` на `admin` или наоборот:

```yaml
- username: ivanov
  password: current_password
  full_name: Иванов Иван Иванович
  department: Отдел добычи
  role: admin  # Было: laborant
  is_active: true
```

Запустите синхронизацию.

### Деактивация пользователя

Установите `is_active: false`:

```yaml
- username: ivanov
  password: current_password
  full_name: Иванов Иван Иванович
  department: Отдел добычи
  role: laborant
  is_active: false  # Пользователь деактивирован
```

Деактивированный пользователь не сможет войти в систему.

### Повторная активация пользователя

Установите `is_active: true` и запустите синхронизацию.

## Безопасность

### Защита конфигурационного файла

- ✅ `config/users_config.yaml` добавлен в `.gitignore` и не попадает в репозиторий
- ✅ Только `config/users_config.yaml.example` версионируется (с примерами, без реальных паролей)
- ⚠️ **Важно:** Не коммитьте `users_config.yaml` в Git!

### Рекомендации по паролям

1. **ОБЯЗАТЕЛЬНО** измените дефолтные пароли при первой настройке
2. Используйте сложные пароли (минимум 8 символов, буквы, цифры, спецсимволы)
3. Разные пароли для разных пользователей
4. Регулярно меняйте пароли (особенно для администраторов)

### Права доступа к файлу

На production сервере установите ограниченные права доступа:

```bash
# Linux/Unix
chmod 600 config/users_config.yaml
chown app_user:app_group config/users_config.yaml

# Только владелец может читать и записывать
```

## Резервное копирование

Регулярно делайте backup конфигурационного файла:

```bash
# Создание backup с датой
cp config/users_config.yaml config/users_config.yaml.backup.$(date +%Y%m%d)

# Или в отдельную директорию
cp config/users_config.yaml /path/to/backups/users_config_$(date +%Y%m%d_%H%M%S).yaml
```

## Устранение проблем

### Скрипт синхронизации не находит конфиг

**Проблема:** `FileNotFoundError: Конфигурационный файл не найден`

**Решение:** Создайте файл на основе примера:
```bash
cp config/users_config.yaml.example config/users_config.yaml
```

### Некорректный формат YAML

**Проблема:** `ValueError: Некорректный формат конфига`

**Решение:** Проверьте синтаксис YAML:
- Правильные отступы (2 пробела, не табы)
- Правильные двоеточия после ключей
- Отсутствие лишних символов

Используйте онлайн валидатор: https://www.yamllint.com/

### Ошибка "Пропущен обязательный параметр"

**Проблема:** `Пропущен username/password/full_name/department для пользователя`

**Решение:** Убедитесь, что все обязательные поля заполнены:
```yaml
- username: user123      # Обязательно
  password: pass123      # Обязательно
  full_name: Фамилия И.О.  # Обязательно
  department: Отдел      # Обязательно
  role: laborant         # Обязательно (admin/laborant)
  is_active: true        # Опционально (по умолчанию true)
```

### Некорректная роль

**Проблема:** `Некорректная роль 'xxx' для пользователя`

**Решение:** Используйте только допустимые значения:
- `admin` - для администраторов
- `laborant` - для лаборантов

## Дополнительные скрипты

### Первичное создание пользователей из БД

Если нужно создать пользователей на основе данных из таблицы `responsibility`:

```bash
uv run python backend/scripts/seed_users.py
```

Этот скрипт:
- Создаст администратора (`admin` / `admin123`)
- Создаст лаборантов на основе `responsible_person` из БД
- Установит дефолтный пароль `lab123` для всех лаборантов

**После этого обязательно измените пароли через `users_config.yaml`!**

## Автоматизация

Для автоматической синхронизации при запуске приложения можно добавить вызов скрипта в startup hook:

```python
# backend/core/main.py
from backend.scripts.sync_users import main as sync_users

@app.on_event("startup")
async def startup_event():
    # Синхронизация пользователей при старте
    try:
        sync_users()
    except Exception as e:
        print(f"Warning: User sync failed: {e}")
```

**Внимание:** Это может замедлить запуск приложения. Используйте только если требуется автоматическая синхронизация.

## Вопросы и поддержка

При возникновении проблем:
1. Проверьте логи скрипта синхронизации
2. Убедитесь в корректности формата YAML
3. Проверьте права доступа к файлу конфигурации
4. Проверьте подключение к базе данных
