# Руководство по импорту данных из Excel в Deltica

## Обзор

Данное руководство описывает процесс подготовки и импорта данных оборудования из Excel файла в систему Deltica. Процесс включает валидацию данных, преобразование форматов и автоматическое исправление распространенных ошибок.

## Требования к Excel файлу

### Структура файла

Excel файл должен содержать следующие колонки (в любом порядке):

#### Основная информация об оборудовании (Equipment)
- `equipment_name` - Название оборудования (обязательное)
- `equipment_model` - Модель оборудования (обязательное, при отсутствии используется equipment_name)
- `equipment_type` - Тип оборудования: 'СИ' или 'ИО' (обязательное)
- `equipment_specs` - Технические характеристики (опциональное)
- `factory_number` - Заводской номер (обязательное, при отсутствии генерируется 'н/д-{id}')
- `inventory_number` - Инвентарный номер (обязательное, при отсутствии генерируется 'н/д-{id}')
- `equipment_year` - Год выпуска (обязательное, при отсутствии используется 2000)

#### Информация о верификации (Verification)
- `verification_type` - Тип верификации: 'поверка', 'калибровка', 'аттестация' (обязательное)
- `registry_number` - Номер в реестре (опциональное)
- `verification_interval` - Интервал верификации в месяцах: 12, 24, 36, 48 и т.д. (обязательное)
- `verification_date` - Дата последней верификации (обязательное, при отсутствии используется текущая дата)
- `verification_plan` - Планируемая дата верификации (обязательное, при отсутствии вычисляется автоматически)
- `verification_state` - Состояние оборудования (обязательное):
  - 'в работе'
  - 'на консервации'
  - 'на верификации'
  - 'в ремонте'
  - 'архив'

#### Ответственные лица (Responsibility)
- `department` - Подразделение (обязательное)
- `responsible_person` - Ответственное лицо (обязательное)
- `verifier_org` - Организация-поверитель (обязательное)

#### Финансовая информация (Finance)
- `budget_item` - Статья бюджета, например "11.03.02.01" (обязательное, при отсутствии используется '00.00.00.0')
- `code_rate` - Тариф, например "24ПВ0240" (опциональное)
- `cost_rate` - Стоимость по тарифу без НДС (опциональное)
- `quantity` - Количество (обязательное, при отсутствии используется 1)
- `coefficient` - Коэффициент (обязательное, при отсутствии используется 1.0)
- `total_cost` - Итоговая стоимость без НДС (опциональное)
- `invoice_number` - Номер счета (опциональное)
- `paid_amount` - Оплаченная сумма (опциональное)
- `payment_date` - Дата оплаты (опциональное)

## Маппинг значений

### Тип оборудования (equipment_type)
```
'СИ' → 'SI' (Средства измерения)
'ИО' → 'IO' (Испытательное оборудование)
```

### Тип верификации (verification_type)
```
'поверка' → 'verification'
'калибровка' → 'calibration'
'аттестация' → 'certification'
```

### Состояние оборудования (verification_state)
```
'в работе' → 'state_work'
'на консервации' → 'state_storage'
'на хранении' → 'state_storage'
'на верификации' → 'state_verification'
'на поверке' → 'state_verification'
'в ремонте' → 'state_repair'
'архив' → 'state_archived'
```

### Подразделения (department)
**ВАЖНО:** Подразделения должны быть указаны точно как в таблице ниже (регистр важен!)

```
'Группа СМ' → 'gruppa_sm'
'ГТЛ' → 'gtl'
'ЛБР' → 'lbr'
'ЛТР' → 'ltr'
'ЛХАиЭИ' → 'lhaiei'
'ОГМК' → 'ogmk'
'ОИИ' → 'oii'
'ОООПС' → 'ooops'
'СМТСиК' → 'smtsik'
'СОИИ' → 'soii'
'ТО' → 'to'
'ТС' → 'ts'
'ЭС' → 'es'
```

## Автоматическая обработка ошибок данных

Скрипт импорта автоматически исправляет следующие проблемы:

### 1. NULL/пустые значения

**equipment_year:**
- NULL или пустое → `2000`
- Если значение является датой (например, `2013-08-20`) → извлекается год (`2013`)

**equipment_model:**
- NULL или пустое → используется значение из `equipment_name`

**factory_number:**
- NULL или пустое → генерируется `'н/д-{equipment_id}'`

**inventory_number:**
- NULL или пустое → генерируется `'н/д-{equipment_id}'`

**verification_date:**
- NULL или пустое → используется текущая дата

**verification_plan:**
- NULL или пустое → вычисляется как `verification_date + verification_interval месяцев`

**budget_item:**
- NULL или пустое → `'00.00.00.0'`

**quantity:**
- NULL или пустое → `1`

**coefficient:**
- NULL или пустое → `1.0`

### 2. Некорректные форматы дат

**Запятая вместо точки:**
```
'07.05,2025' → '2025-05-07'
```

Скрипт автоматически исправляет и конвертирует в формат ISO (YYYY-MM-DD).

### 3. Datetime объекты

Если в ячейке Excel хранится datetime объект вместо даты, он автоматически конвертируется в дату.

## Процесс импорта

### Шаг 1: Подготовка Excel файла

1. Убедитесь, что файл называется `export_equipment_db.xlsx`
2. Разместите файл в корневой директории проекта `C:\Projects\deltica\`
3. Проверьте, что все обязательные колонки присутствуют
4. Используйте русские названия для значений (они будут автоматически преобразованы)

### Шаг 2: Генерация SQL скрипта

Выполните команду:
```bash
uv run python backend/scripts/import_equipment_data.py
```

**Вывод:**
```
Чтение данных из C:\Projects\deltica\export_equipment_db.xlsx...
Загружено 1338 строк
Колонки: ['equipment_name', 'equipment_model', ...]

Генерация SQL скрипта...
SQL скрипт сохранен в C:\Projects\deltica\import_equipment_data.sql
Всего команд: 6710

✅ Готово!
```

### Шаг 3: Выполнение импорта

**ВНИМАНИЕ:** Этот скрипт удалит ВСЕ существующие данные оборудования!

Выполните команду:
```bash
uv run python backend/scripts/execute_import_sql.py
```

При запросе подтверждения введите `yes`:
```
⚠️  ВНИМАНИЕ: Этот скрипт удалит ВСЕ существующие данные оборудования!
Продолжить? (yes/no): yes
```

**Успешный импорт:**
```
✅ SQL скрипт успешно выполнен!
Транзакция зафиксирована.
```

### Шаг 4: Проверка данных

1. Запустите приложение: `.\start.ps1`
2. Войдите под пользователем-лаборантом (например, `cherkashin` / `lab123`)
3. Убедитесь, что отображается оборудование соответствующего подразделения
4. Проверьте корректность данных в таблице

## Типичные ошибки и решения

### Ошибка: "null value in column ... violates not-null constraint"

**Причина:** В Excel файле есть обязательные поля, содержащие NULL значения.

**Решение:** Проверьте следующие обязательные поля:
- `equipment_name`
- `verification_type`
- `verification_interval`
- `department`
- `responsible_person`
- `verifier_org`

### Ошибка: "invalid input value for enum ..."

**Причина:** Значение не соответствует ни одному из допустимых значений enum.

**Решение:** Проверьте маппинг значений в разделе "Маппинг значений" выше.

### Ошибка: "invalid input syntax for type date"

**Причина:** Некорректный формат даты в Excel.

**Решение:** Убедитесь, что даты в Excel имеют формат даты (а не текста).

### Предупреждение: "Data Validation extension is not supported"

**Причина:** Excel файл содержит правила валидации данных.

**Решение:** Это предупреждение можно игнорировать - оно не влияет на импорт.

## Проверка данных после импорта

### SQL запросы для проверки

**Количество записей:**
```sql
SELECT COUNT(*) FROM equipment;
SELECT COUNT(*) FROM verification;
SELECT COUNT(*) FROM responsibility;
SELECT COUNT(*) FROM finance;
```

**Распределение по подразделениям:**
```sql
SELECT department, COUNT(*)
FROM responsibility
GROUP BY department
ORDER BY COUNT(*) DESC;
```

**Проверка маппинга подразделений:**
```sql
SELECT DISTINCT department FROM responsibility;
-- Должны быть технические значения: gtl, lbr, ltr и т.д.
-- НЕ должно быть: ГТЛ, ЛБР, ЛТР
```

**Оборудование с дефолтными значениями:**
```sql
-- Оборудование с дефолтным годом
SELECT equipment_name, equipment_year
FROM equipment
WHERE equipment_year = 2000;

-- Оборудование с дефолтными номерами
SELECT equipment_name, factory_number, inventory_number
FROM equipment
WHERE factory_number LIKE 'н/д-%' OR inventory_number LIKE 'н/д-%';
```

## Структура скриптов импорта

### backend/scripts/import_equipment_data.py

Основной скрипт импорта:
- Читает Excel файл с помощью pandas
- Применяет маппинг значений
- Обрабатывает NULL значения и ошибки данных
- Генерирует SQL INSERT команды
- Сохраняет результат в `import_equipment_data.sql`

### backend/scripts/execute_import_sql.py

Скрипт выполнения SQL:
- Читает сгенерированный SQL файл
- Выполняет импорт через SQLAlchemy
- Использует транзакции для безопасности
- Откатывает изменения при ошибках

### backend/scripts/check_unique_values.py

Вспомогательный скрипт для анализа данных:
- Показывает уникальные значения по колонкам
- Помогает найти несоответствия в данных
- Полезен для отладки проблем импорта

## Рекомендации по подготовке данных

### 1. Проверка перед импортом

Используйте вспомогательный скрипт для анализа данных:
```bash
uv run python backend/scripts/check_unique_values.py
```

Это покажет уникальные значения для критических полей и поможет выявить проблемы.

### 2. Резервное копирование

Перед импортом создайте резервную копию БД:
```bash
# Через приложение: Admin Panel → Backup БД
# Или через pg_dump:
pg_dump -U postgres -d deltica_db > backup_before_import.sql
```

### 3. Тестовый импорт

Рекомендуется:
1. Сначала протестировать импорт на копии БД
2. Проверить несколько случайных записей
3. Убедиться в корректности маппинга подразделений
4. Только потом выполнять импорт в production БД

### 4. Проверка пользователей

После импорта убедитесь, что все лаборанты видят свое оборудование:

**Тестовые пользователи:**
- `cherkashin` / `lab123` - подразделение ЛБР
- `petrova` / `lab123` - подразделение ГТЛ
- `morozov` / `lab123` - подразделение ЛТР

## Дополнительные возможности

### Частичный импорт

Если нужно импортировать только часть данных:

1. Отфильтруйте строки в Excel
2. Сохраните в новый файл `export_equipment_db.xlsx`
3. Запустите импорт

### Обновление данных

Для обновления существующих данных вместо полной замены:

1. Экспортируйте текущие данные
2. Внесите изменения в Excel
3. Измените скрипт импорта (закомментируйте строки DELETE)
4. Используйте UPDATE вместо INSERT для существующих записей

**Примечание:** В текущей версии поддерживается только полная замена данных.

## Поддержка и отладка

### Логи импорта

При ошибке скрипт выводит подробную информацию:
- Номер строки с ошибкой
- Название поля
- Значение, вызвавшее ошибку
- Текст SQL команды

### Контакты

При возникновении проблем:
1. Проверьте раздел "Типичные ошибки и решения"
2. Используйте скрипт `check_unique_values.py` для анализа
3. Проверьте SQL запросы в разделе "Проверка данных"

## История изменений

**Версия 1.0 (2025-10-20)**
- Первая версия документации
- Добавлена поддержка маппинга подразделений
- Автоматическая обработка NULL значений
- Исправление некорректных форматов дат
