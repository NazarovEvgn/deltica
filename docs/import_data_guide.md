# Руководство по импорту данных оборудования

## Обзор

Данное руководство описывает процесс импорта данных метрологического оборудования из Excel файла в базу данных PostgreSQL системы Deltica.

## Требования

- Python 3.13+ с установленным `uv` менеджером пакетов
- PostgreSQL база данных `deltica_db`
- Настроенный файл `.env` с корректными параметрами подключения к БД
- Excel файл с данными в корректном формате

## Структура Excel файла для импорта

### Требуемые колонки (24 колонки)

Excel файл должен содержать следующие колонки в первой строке:

#### Информация об оборудовании (Equipment):
1. `equipment_name` - Название оборудования (обязательно)
2. `equipment_model` - Модель оборудования
3. `equipment_type` - Тип: `СИ` или `ИО`
4. `equipment_specs` - Технические характеристики
5. `equipment_year` - Год выпуска
6. `factory_number` - Заводской номер
7. `inventory_number` - Инвентарный номер

#### Информация о верификации (Verification):
8. `verification_type` - Тип: `поверка`, `калибровка`, `аттестация`
9. `verification_state` - Состояние: `в работе`, `на консервации`, `на поверке`, `в ремонте`, `архив`
10. `verification_interval` - Межповерочный интервал (месяцы)
11. `verification_date` - Дата последней поверки (формат: YYYY-MM-DD)
12. `verification_plan` - Плановая дата следующей поверки (формат: YYYY-MM-DD)
13. `registry_number` - Регистрационный номер

#### Информация об ответственных (Responsibility):
14. `department` - Подразделение: `ГТЛ`, `ЛБР`, `ОИИ`, `ЛХАиЭИ`, `ЛТР`, `ЭС`, `ОГМК`, `ОООПС`, `Группа СМ`, `СМТСиК`, `СОИИ`, `ТО`, `ТС`
15. `responsible_person` - Ответственное лицо
16. `verifier_org` - Организация-поверитель

#### Финансовая информация (Finance):
17. `budget_item` - Статья бюджета
18. `code_rate` - Тариф (код)
19. `cost_rate` - Стоимость по тарифу (без НДС)
20. `quantity` - Количество
21. `coefficient` - Дополнительный коэффициент
22. `paid_amount` - Факт оплаты
23. `invoice_number` - Номер счета
24. `payment_date` - Дата оплаты (формат: YYYY-MM-DD)

### Маппинг значений

Скрипт импорта автоматически конвертирует русские значения в технические значения БД:

**Тип оборудования:**
- `СИ` → `SI` (средства измерения)
- `ИО` → `IO` (испытательное оборудование)

**Тип верификации:**
- `поверка` → `verification`
- `калибровка` → `calibration`
- `аттестация` → `certification`

**Состояние:**
- `в работе` → `state_work`
- `на хранении` → `state_storage`
- `на консервации` → `state_storage`
- `на поверке` → `state_verification`
- `на верификации` → `state_verification`
- `в ремонте` → `state_repair`
- `архив` → `state_archived`

**Подразделения:**
- `Группа СМ` → `gruppa_sm`
- `ГТЛ` → `gtl`
- `ЛБР` → `lbr`
- `ЛТР` → `ltr`
- `ЛХАиЭИ` → `lhaiei`
- `ОГМК` → `ogmk`
- `ОИИ` → `oii`
- `ОООПС` → `ooops`
- `СМТСиК` → `smtsik`
- `СОИИ` → `soii`
- `ТО` → `to`
- `ТС` → `ts`
- `ЭС` → `es`

### Обработка NULL значений

Скрипт импорта автоматически подставляет дефолтные значения для пустых обязательных полей:

- `equipment_year`: `2000` (если отсутствует)
- `equipment_model`: копируется из `equipment_name` (если отсутствует)
- `factory_number`: `н/д-{id}` (если отсутствует)
- `inventory_number`: `н/д-{id}` (если отсутствует)
- `verification_date`: текущая дата (если отсутствует)
- `verification_plan`: вычисляется как `verification_date + verification_interval` (если отсутствует)
- `budget_item`: `00.00.00.0` (если отсутствует)
- `quantity`: `1` (если отсутствует)
- `coefficient`: `1.0` (если отсутствует)
- `total_cost`: вычисляется как `cost_rate × quantity × coefficient`

## Процесс импорта

### Подготовка

1. Разместите Excel файл в корне проекта с именем `import data.xlsx`
2. Убедитесь, что первая строка содержит названия колонок
3. Убедитесь, что база данных запущена и доступна

### Шаг 1: Генерация SQL скрипта

Запустите скрипт генерации SQL:

```bash
uv run python backend/scripts/import_new_data.py
```

**Что происходит:**
- Чтение данных из Excel файла
- Исправление опечаток в названиях колонок (например, `equipmnet_model` → `equipment_model`)
- Маппинг русских значений в технические значения БД
- Обработка NULL значений с подстановкой дефолтов
- Генерация SQL скрипта `import_new_data.sql` в корне проекта

**Вывод:**
```
Чтение данных из C:\Projects\deltica\import data.xlsx...
⚠️  Исправлена опечатка: equipmnet_model → equipment_model
Загружено 1334 строк
Колонки: [список колонок...]

Генерация SQL скрипта...
✅ SQL скрипт сохранен в C:\Projects\deltica\import_new_data.sql
Всего команд: 6690

================================================================================
✅ Готово!
================================================================================

Создан SQL скрипт: C:\Projects\deltica\import_new_data.sql
Записей для импорта: 1334
```

### Шаг 2: Выполнение импорта в БД

**⚠️ ВНИМАНИЕ:** Этот шаг удалит ВСЕ существующие данные в таблицах:
- `equipment`
- `verification`
- `responsibility`
- `finance`
- `equipment_files`

#### Интерактивный режим (с подтверждением):

```bash
uv run python backend/scripts/execute_new_import.py
```

Скрипт попросит подтверждение:
```
Продолжить? (yes/no):
```

Введите `yes` для продолжения.

#### Автоматический режим (без подтверждения):

```bash
echo yes | uv run python backend/scripts/execute_new_import.py
```

**Что происходит:**
- Чтение SQL скрипта
- Начало транзакции
- Очистка существующих данных из всех таблиц
- Сброс последовательностей (ID счётчики)
- Вставка новых данных для всех таблиц
- Обновление последовательностей
- Фиксация транзакции

**Вывод при успехе:**
```
================================================================================
ИМПОРТ ДАННЫХ ИЗ 'import data.xlsx' В БАЗУ ДАННЫХ
================================================================================

⚠️  ВНИМАНИЕ: Этот скрипт удалит ВСЕ существующие данные оборудования!
⚠️  Будут очищены таблицы: equipment, verification, responsibility, finance

Продолжить? (yes/no): yes

Начинаем импорт...

Чтение SQL скрипта из C:\Projects\deltica\import_new_data.sql...
Размер SQL скрипта: 1193376 символов

Начало транзакции...

✅ SQL скрипт успешно выполнен!
Транзакция зафиксирована.

================================================================================
✅ ИМПОРТ ЗАВЕРШЕН УСПЕШНО
================================================================================

Импортировано записей из файла 'import data.xlsx'
Проверьте данные в приложении или через pgAdmin4.
```

### Шаг 3: Проверка результатов

#### Через приложение Deltica:

1. Запустите backend: `uv run uvicorn backend.core.main:app --reload`
2. Запустите frontend: `cd frontend && npm run dev`
3. Откройте приложение в браузере
4. Проверьте наличие данных в основной таблице

#### Через SQL запрос:

Создайте временный скрипт проверки:

```python
from sqlalchemy import text
from backend.core.database import engine

with engine.connect() as connection:
    # Проверка количества записей
    tables = ['equipment', 'verification', 'responsibility', 'finance']
    for table in tables:
        result = connection.execute(text(f"SELECT COUNT(*) FROM {table}"))
        count = result.scalar()
        print(f"{table}: {count} записей")
```

#### Ожидаемые результаты:

Все таблицы должны содержать одинаковое количество записей (равное количеству строк в Excel файле):

```
equipment: 1334 записей
verification: 1334 записей
responsibility: 1334 записей
finance: 1334 записей
```

## Структура созданных файлов

### Скрипты импорта:

1. **`backend/scripts/import_new_data.py`**
   - Читает Excel файл
   - Генерирует SQL скрипт для импорта
   - Обрабатывает маппинг значений и NULL значения

2. **`backend/scripts/execute_new_import.py`**
   - Выполняет SQL скрипт через SQLAlchemy
   - Использует транзакции для безопасности
   - Запрашивает подтверждение перед удалением данных

### Генерируемые файлы:

3. **`import_new_data.sql`** (в корне проекта)
   - Автоматически генерируемый SQL скрипт
   - Содержит команды очистки и вставки данных
   - Можно удалить после успешного импорта

## Безопасность и откат

### Транзакции

Импорт выполняется внутри транзакции:
- Если произойдёт ошибка на любом этапе, вся транзакция откатывается
- База данных остаётся в консистентном состоянии

### Резервное копирование

**⚠️ ВАЖНО:** Перед импортом рекомендуется создать backup базы данных!

#### Создание backup через приложение:

1. Войдите как администратор
2. Откройте "Админ панель" → "Backup БД"
3. Нажмите "Создать backup"

#### Создание backup через командную строку:

```bash
# Найти путь к pg_dump
where pg_dump

# Создать backup
pg_dump -U your_user -d deltica_db -F c -b -v -f "backup_before_import.backup"
```

#### Восстановление из backup:

```bash
# Восстановление через pg_restore
pg_restore -U your_user -d deltica_db -v "backup_before_import.backup"
```

## Решение проблем

### Ошибка: "Файл import data.xlsx не найден"

**Причина:** Excel файл не находится в корне проекта или имеет неправильное имя.

**Решение:**
- Убедитесь, что файл называется точно `import data.xlsx` (с пробелом)
- Разместите файл в `C:\Projects\deltica\import data.xlsx`

### Ошибка: "UnicodeEncodeError"

**Причина:** Проблемы с кодировкой консоли Windows.

**Решение:**
- Скрипт автоматически устанавливает UTF-8 кодировку
- Если проблема сохраняется, выполните: `chcp 65001` перед запуском

### Ошибка: "sqlalchemy.exc.OperationalError: could not connect to server"

**Причина:** База данных недоступна или неверные параметры подключения.

**Решение:**
1. Проверьте, что PostgreSQL запущен
2. Проверьте настройки в `.env` файле:
   ```
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=deltica_db
   DB_USER=your_user
   DB_PASSWORD=your_password
   ```

### Ошибка: "Колонка отсутствует в Excel файле"

**Причина:** Excel файл не содержит все требуемые колонки.

**Решение:**
- Проверьте, что первая строка Excel файла содержит все 24 колонки
- Сверьте названия колонок с разделом "Требуемые колонки"

### Ошибка при выполнении SQL: "syntax error at or near"

**Причина:** Некорректные данные в Excel файле (например, специальные символы в строках).

**Решение:**
- Проверьте данные на наличие одинарных кавычек (`'`)
- Скрипт автоматически экранирует кавычки, но проверьте особые случаи
- Откройте `import_new_data.sql` и найдите проблемную строку

### Данные импортировались, но неверные значения

**Причина:** Неверный маппинг или некорректные исходные данные.

**Решение:**
1. Проверьте маппинг значений в разделе "Маппинг значений"
2. Убедитесь, что в Excel используются правильные русские значения
3. Проверьте данные в сгенерированном `import_new_data.sql`

## Повторный импорт

Для повторного импорта новых данных:

1. Замените файл `import data.xlsx` на новый
2. Повторите шаги 1-3 из раздела "Процесс импорта"

**Примечание:** Каждый новый импорт полностью заменяет существующие данные!

## Частичный импорт (добавление данных)

Если нужно добавить данные без удаления существующих:

1. Отредактируйте скрипт `import_new_data.py`
2. Закомментируйте секцию очистки данных (строки с `DELETE FROM` и `ALTER SEQUENCE`)
3. Запустите генерацию и импорт как обычно

**⚠️ Внимание:** При частичном импорте могут возникнуть конфликты ID!

## Миграция данных между окружениями

### Экспорт данных из production:

```bash
# Создать Excel export через приложение
# Админ панель → Backup БД → Экспорт в Excel
```

Или через SQL:

```sql
COPY (
    SELECT * FROM equipment e
    LEFT JOIN verification v ON e.id = v.equipment_id
    LEFT JOIN responsibility r ON e.id = r.equipment_id
    LEFT JOIN finance f ON e.id = f.equipment_model_id
) TO 'export_data.csv' WITH CSV HEADER;
```

### Импорт в другое окружение:

1. Конвертируйте CSV в Excel (если нужно)
2. Следуйте стандартному процессу импорта

## Лучшие практики

1. **Всегда делайте backup** перед импортом
2. **Проверяйте данные** в Excel файле перед импортом
3. **Тестируйте на копии БД** перед production импортом
4. **Логируйте результаты** импорта для аудита
5. **Удаляйте SQL скрипты** после успешного импорта (содержат потенциально чувствительные данные)

## Контрольный чеклист

- [ ] Создан backup базы данных
- [ ] Excel файл размещён в `C:\Projects\deltica\import data.xlsx`
- [ ] Проверена структура Excel файла (24 колонки)
- [ ] Запущен скрипт генерации SQL
- [ ] Проверен сгенерированный SQL скрипт (опционально)
- [ ] Запущен скрипт импорта с подтверждением
- [ ] Проверены результаты импорта
- [ ] Удалён временный SQL файл

## Дополнительная информация

### Документация по моделям данных:

См. `backend/app/models.py` для полной структуры таблиц БД.

### Документация по маппингу:

См. `docs/data_import_guide.md` для детального описания маппинга значений.

### Поддержка:

При возникновении проблем обратитесь к разделу "Решение проблем" или проверьте логи:
- Backend логи: `backend/logs/deltica.log`
- PostgreSQL логи: в зависимости от установки
